<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XO-Tube Enjambre</title>
    <style>
        /* Estilo ultra-ligero y oscuro */
        body { background-color: #000; color: #0f0; font-family: 'Courier New', monospace; text-align: center; margin: 0; padding: 10px; }
        
        .container { max-width: 700px; margin: 0 auto; border: 2px solid #333; padding: 10px; background: #111; }
        
        /* Reproductor Nativo Limpio */
        video { width: 100%; aspect-ratio: 16/9; background: #000; border: 1px solid #444; display: none; }
        
        .controls { display: none; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; }
        
        button { 
            padding: 12px; background: #222; color: white; border: 1px solid #555; 
            cursor: pointer; font-weight: bold; font-size: 14px;
        }
        button:hover { background: #444; }
        .active { background: #006600; border-color: #00ff00; }
        
        input { width: 80%; padding: 10px; background: #222; color: white; border: 1px solid #555; margin-bottom: 10px; }
        
        #log { font-size: 12px; color: #ffaa00; margin-top: 10px; min-height: 20px; text-align: left; padding: 5px; border-top: 1px solid #333; }
        .success { color: #00ff00 !important; }
        .error { color: #ff3333 !important; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin:5px 0;">XO-TUBE <span style="font-size:0.6em; color:#888;">(Modo Enjambre)</span></h2>
    
    <input type="text" id="urlInput" placeholder="Pega el link de YouTube aquí...">
    <br>
    <button onclick="iniciarCarga()" style="width: 50%; background: #004488;">BUSCAR VIDEO</button>

    <div id="log">Esperando enlace...</div>

    <video id="miVideo" controls playsinline poster="https://via.placeholder.com/640x360/000000/ffffff?text=Cargando..."></video>

    <div class="controls" id="panelControl">
        <button onclick="cambiarCalidad('144p')" id="btn144">144p</button>
        <button onclick="cambiarCalidad('240p')" id="btn240">240p</button>
        <button onclick="cambiarCalidad('360p')" id="btn360">360p</button>
        <button onclick="pantallaCompleta()" style="background:#550055;">FullScr</button>
    </div>
</div>

<script>
    // LISTA DE SERVIDORES (El Enjambre)
    // Si uno falla, el código prueba el siguiente automáticamente.
    const servidores = [
        "https://pipedapi.kavin.rocks",
        "https://api.piped.victr.me",
        "https://pipedapi.leptons.xyz",
        "https://pipedapi.r4fo.com",
        "https://piped-api.lunar.icu",
        "https://api.piped.privacy.com.de",
        "https://pipedapi.drgns.space",
        "https://pa.il.ax" 
    ];

    let videoId = "";
    let datosVideo = null;
    const log = document.getElementById('log');
    const video = document.getElementById('miVideo');
    const panel = document.getElementById('panelControl');

    function logMsg(msg, tipo) {
        log.innerText = ">> " + msg;
        log.className = tipo || "";
    }

    async function iniciarCarga() {
        const url = document.getElementById('urlInput').value;
        const match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
        
        if (!match) return logMsg("Link incorrecto. Revisa la URL.", "error");
        
        videoId = match[1];
        video.style.display = "none";
        panel.style.display = "none";
        datosVideo = null;
        
        // Empezamos la búsqueda en el enjambre
        buscarEnEnjambre();
    }

    async function buscarEnEnjambre() {
        for (let i = 0; i < servidores.length; i++) {
            const servidor = servidores[i];
            logMsg(`Intentando servidor ${i+1}/${servidores.length}: ${servidor.split('/')[2]}...`, "");

            try {
                // Hacemos la petición con un tiempo límite de 4 segundos por servidor
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);

                const respuesta = await fetch(`${servidor}/streams/${videoId}`, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (respuesta.ok) {
                    const datos = await respuesta.json();
                    if (!datos.videoStreams || datos.videoStreams.length === 0) throw new Error("Sin streams");
                    
                    datosVideo = datos; // Guardamos los datos para cambiar calidad luego
                    logMsg(`¡CONECTADO! Título: ${datos.title}`, "success");
                    
                    // Activamos la interfaz
                    video.style.display = "block";
                    panel.style.display = "grid";
                    
                    // Por defecto cargamos 240p o la más baja
                    cambiarCalidad('240p');
                    return; // ¡ÉXITO! Salimos del bucle
                }
            } catch (error) {
                console.log("Fallo servidor: " + servidor);
                // Si falla, el bucle 'for' simplemente pasa al siguiente
            }
        }
        logMsg("❌ ERROR FATAL: Ningún servidor respondió. Intenta en 5 min.", "error");
    }

    function cambiarCalidad(calidad) {
        if (!datosVideo) return;
        
        logMsg(`Cambiando a calidad: ${calidad}...`, "");
        
        // Buscamos el stream mp4
        let stream = datosVideo.videoStreams.find(s => s.quality === calidad && s.format === 'MPEG-4');
        
        // Si no encuentra MP4, busca WebM
        if (!stream) stream = datosVideo.videoStreams.find(s => s.quality === calidad);
        
        // Si no encuentra la calidad exacta, busca la más cercana (fallback)
        if (!stream && calidad === '240p') stream = datosVideo.videoStreams.find(s => s.quality === '360p');
        if (!stream) stream = datosVideo.videoStreams[0]; // El primero que haya

        if (stream) {
            const tiempoActual = video.currentTime;
            video.src = stream.url;
            video.currentTime = tiempoActual;
            video.play();
            
            // Actualizar botones visualmente
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn'+calidad.replace('p',''))?.classList.add('active');
            
            logMsg(`Reproduciendo en ${stream.quality} (${stream.format})`, "success");
        } else {
            logMsg("Esa calidad no está disponible para este video.", "error");
        }
    }

    function pantallaCompleta() {
        if (video.requestFullscreen) video.requestFullscreen();
        else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen(); // Safari/Old Chrome
        else if (video.mozRequestFullScreen) video.mozRequestFullScreen(); // Firefox
    }
</script>

</body>
</html>
