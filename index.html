<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XO-Tube Final</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #444; background: #2b2b2b; color: white; }
        button { width: 95%; padding: 12px; background: #00a0e9; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        video { width: 100%; margin-top: 20px; border-radius: 5px; display: none; background: black; }
        #estado { margin-top: 15px; color: #00ff00; font-size: 0.9em; }
        .error { color: #ff4444 !important; }
    </style>
</head>
<body>

<div class="container">
    <h1>XO-Tube </h1>
    <p style="font-size: 0.8em; color: #888;">Si no carga, pulsa el bot贸n de nuevo</p>
    <input type="text" id="url" placeholder="Pega el link de YouTube aqu铆">
    <button onclick="reproducir()">REPRODUCIR VIDEO</button>
    <div id="estado">Listo para conectar.</div>
    <video id="vid" controls autoplay></video>
</div>

<script>
    async function reproducir() {
        const urlInput = document.getElementById('url').value;
        const estado = document.getElementById('estado');
        const video = document.getElementById('vid');

        const match = urlInput.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
        if (!match) return alert("Link inv谩lido");
        const id = match[1];

        // Lista de servidores de video (Instancias de Invidious)
        const instancias = [
            "https://invidious.snopyta.org",
            "https://yewtu.be",
            "https://invidious.kavin.rocks",
            "https://vid.puffyan.us"
        ];
        
        // Elegimos una instancia al azar cada vez para no saturarla
        const instancia = instancias[Math.floor(Math.random() * instancias.length)];
        
        estado.classList.remove('error');
        estado.innerText = "Conectando al t煤nel seguro...";
        video.style.display = "none";

        try {
            // Usamos un proxy p煤blico para saltar el bloqueo de "Saturaci贸n/CORS"
            const proxyUrl = "https://api.allorigins.win/get?url=";
            const targetUrl = encodeURIComponent(`${instancia}/api/v1/videos/${id}`);
            
            const res = await fetch(proxyUrl + targetUrl);
            const json = await res.json();
            const data = JSON.parse(json.contents);

            // Buscamos el video MP4 de 360p o 720p
            const format = data.formatStreams.find(f => f.container === "mp4") || data.formatStreams[0];

            if (format) {
                let videoUrl = format.url;
                // Si el link es relativo, le ponemos la direcci贸n de la instancia
                if (videoUrl.startsWith('/')) {
                    videoUrl = instancia + videoUrl;
                }

                video.src = videoUrl;
                video.style.display = "block";
                estado.innerText = "Reproduciendo: " + data.title;
            } else {
                estado.classList.add('error');
                estado.innerText = "No se encontr贸 un formato MP4 compatible.";
            }
        } catch (e) {
            estado.classList.add('error');
            estado.innerText = "El t煤nel fall贸. Prueba darle al bot贸n otra vez.";
            console.error(e);
        }
    }
</script>

</body>
</html>
