<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XO-Tube Proxy</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; text-align: center; margin: 0; padding: 10px; }
        .box { max-width: 600px; margin: 0 auto; border: 2px solid #333; padding: 15px; background: #111; }
        
        /* Reproductor nativo limpio */
        video { width: 100%; border: 1px solid #444; background: #000; margin-top: 15px; display: none; }
        
        input { width: 70%; padding: 10px; background: #222; color: white; border: 1px solid #555; }
        button { padding: 10px; background: #004400; color: white; border: 1px solid #00ff00; cursor: pointer; font-weight: bold; }
        button:hover { background: #006600; }
        
        .controls { display: none; margin-top: 10px; gap: 5px; justify-content: center; }
        .active { background: #0088ff !important; border-color: white; }
        
        #status { margin-top: 10px; font-size: 12px; color: yellow; min-height: 20px; }
    </style>
</head>
<body>

<div class="box">
    <h2>XO-TUBE <span style="font-size:0.6em; color:orange;">(Versión Proxy)</span></h2>
    
    <input type="text" id="url" placeholder="Pega el link de YouTube...">
    <button onclick="buscar()">VER VIDEO</button>
    
    <div id="status">Listo.</div>

    <video id="vid" controls playsinline></video>
    
    <div class="controls" id="ctrls">
        <button onclick="cambiarCalidad('144p')" id="btn144">144p</button>
        <button onclick="cambiarCalidad('240p')" id="btn240">240p</button>
        <button onclick="cambiarCalidad('360p')" id="btn360">360p</button>
    </div>
</div>

<script>
    let streamData = null;
    const status = document.getElementById('status');
    const video = document.getElementById('vid');

    async function buscar() {
        const input = document.getElementById('url').value;
        const match = input.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
        if (!match) return status.innerText = "Error: Link inválido";
        
        const id = match[1];
        status.innerText = "Usando Proxy para saltar bloqueo...";
        status.style.color = "yellow";
        video.style.display = "none";
        document.getElementById('ctrls').style.display = "none";

        // Usamos una instancia de Piped que suele ser rápida
        const targetApi = `https://pipedapi.kavin.rocks/streams/${id}`;
        
        // EL TRUCO: Usamos 'api.allorigins.win' para que el navegador no bloquee la petición
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetApi)}`;

        try {
            const res = await fetch(proxyUrl);
            if (!res.ok) throw new Error("Proxy falló");
            
            const data = await res.json();
            
            if (data.error) throw new Error(data.error);

            streamData = data.videoStreams;
            status.innerText = "¡Video encontrado! Cargando...";
            status.style.color = "#00ff00";
            
            // Mostrar reproductor y controles
            video.style.display = "block";
            document.getElementById('ctrls').style.display = "flex";
            
            // Intentar cargar la calidad más baja primero
            cambiarCalidad('240p');
            
        } catch (e) {
            console.error(e);
            status.innerText = "Error: " + e.message + ". Intenta otro video.";
            status.style.color = "red";
        }
    }

    function cambiarCalidad(calidad) {
        if (!streamData) return;
        
        status.innerText = "Cambiando a " + calidad + "...";
        
        // Buscar stream mp4 o webm
        let stream = streamData.find(s => s.quality === calidad && s.format === 'MPEG-4');
        if (!stream) stream = streamData.find(s => s.quality === calidad);
        
        // Fallback si no existe esa calidad exacta
        if (!stream && calidad === '240p') stream = streamData.find(s => s.quality === '360p');
        if (!stream) stream = streamData[0]; // El que sea

        if (stream) {
            const tiempo = video.currentTime;
            video.src = stream.url;
            video.currentTime = tiempo;
            video.play();
            status.innerText = "Reproduciendo: " + calidad;
            
            // Marcar botón activo
            document.querySelectorAll('.controls button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn'+calidad.replace('p','')).classList.add('active');
        } else {
            status.innerText = "No disponible en " + calidad;
        }
    }
</script>

</body>
</html>
