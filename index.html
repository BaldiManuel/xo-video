<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>XO-Video Pro</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; text-align: center; padding: 10px; }
        .player-box { max-width: 600px; margin: 0 auto; background: #000; border: 2px solid #444; border-radius: 8px; overflow: hidden; }
        
        /* Video puro, sin nada de YouTube */
        video { width: 100%; display: block; background: #000; }
        
        .controls { background: #333; padding: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        input { width: 80%; padding: 10px; margin: 10px 0; border-radius: 4px; border: none; }
        
        button { 
            padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
            background: #444; color: white;
        }
        button:hover { background: #666; }
        .btn-play { background: #28a745; }
        .btn-qual { background: #007bff; }
        .btn-fs { background: #6f42c1; }
        
        #status { font-size: 12px; padding: 5px; color: #888; }
    </style>
</head>
<body>

<div class="player-box">
    <video id="mainVideo" playsinline></video>
    
    <div class="controls" id="ui" style="display:none;">
        <button class="btn-play" onclick="togglePlay()">PAUSA/PLAY</button>
        <button class="btn-fs" onclick="openFS()">PANTALLA COMPLETA</button>
        <button onclick="rewind()">-10s</button>
        
        <button class="btn-qual" onclick="changeQ('144p')">144p</button>
        <button class="btn-qual" onclick="changeQ('240p')">240p</button>
        <button class="btn-qual" onclick="changeQ('360p')">360p</button>
    </div>
</div>

<input type="text" id="vUrl" placeholder="Pega el link de YouTube aquí">
<br>
<button onclick="loadStream()" style="background:#ff0000; width:200px;">CARGAR VIDEO</button>
<div id="status">Esperando link...</div>

<script>
    let video = document.getElementById('mainVideo');
    let status = document.getElementById('status');
    let currentId = "";

    async function loadStream() {
        let url = document.getElementById('vUrl').value;
        let match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]{11})/);
        if(!match) return alert("Link inválido");
        
        currentId = match[1];
        status.innerText = "Saltando anuncios y buscando fuentes...";
        document.getElementById('ui').style.display = "grid";
        
        changeQ('240p'); // Calidad inicial por defecto
    }

    async function changeQ(quality) {
        status.innerText = "Cargando calidad: " + quality + "...";
        let time = video.currentTime;
        
        // Usamos una API de stream directo que se salta la interfaz de YT
        // Probamos con múltiples instancias de Cobra/Piped para asegurar conexión
        const instances = ['https://pipedapi.kavin.rocks', 'https://api.piped.victr.me', 'https://pipedapi.lunar.icu'];
        
        for (let inst of instances) {
            try {
                let res = await fetch(`${inst}/streams/${currentId}`);
                let data = await res.json();
                
                // Buscamos exactamente la calidad que pidió el usuario
                let stream = data.videoStreams.find(s => s.quality === quality) || data.videoStreams[0];
                
                if (stream.url) {
                    video.src = stream.url;
                    video.currentTime = time;
                    video.play();
                    status.innerText = "Viendo en " + quality + " (Sin anuncios)";
                    return;
                }
            } catch (e) {
                console.log("Fallo instancia, probando otra...");
            }
        }
        status.innerText = "Error de conexión. Reintenta.";
    }

    function togglePlay() { video.paused ? video.play() : video.pause(); }
    function rewind() { video.currentTime -= 10; }
    function openFS() {
        if (video.requestFullscreen) video.requestFullscreen();
        else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
    }
</script>

</body>
</html>
